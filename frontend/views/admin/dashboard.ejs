<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Dincosarl</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/admin.css">
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <%- include('../partials/adminHeader', { title: 'Tableau de bord - Dincosarl' }) %>
    <div class="container-fluid">
        <div class="row">
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
                <h1 class="h2">Tableau de bord</h1>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Utilisateurs</h5>
                                <p class="card-text">Nombre total d'utilisateurs : <%= usersCount %></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Commandes</h5>
                                <p class="card-text">Nombre total de commandes : <%= ordersCount %></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Contacts</h5>
                                <p class="card-text">Nombre total de contacts : <%= contactsCount %></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h3>Visites récentes</h3>
                        <div class="chart-container">
                            <canvas id="visitChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h3>Évolution des commandes</h3>
                        <div class="chart-container">
                            <canvas id="ordersChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h3>Évolution des contacts</h3>
                        <div class="chart-container">
                            <canvas id="contactsChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h3>Évolution des utilisateurs</h3>
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <%- include('../partials/adminFooter') %>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        $.ajax({
            url: '/admin/evolution-data',
            method: 'GET',
            success: function(data) {
                const ordersLabels = data.ordersEvolution.map(item => `Mois ${item.month}`);
                const ordersData = data.ordersEvolution.map(item => item.count);

                const contactsLabels = data.contactsEvolution.map(item => `Mois ${item.month}`);
                const contactsData = data.contactsEvolution.map(item => item.count);

                const usersLabels = data.usersEvolution.map(item => `Mois ${item.month}`);
                const usersData = data.usersEvolution.map(item => item.count);

                const visitsLabels = data.visitsEvolution.map(item => `Mois ${item.month}`);
                const visitsData = data.visitsEvolution.map(item => item.count);

                const ctxOrders = document.getElementById('ordersChart').getContext('2d');
                const ordersChart = new Chart(ctxOrders, {
                    type: 'bar',
                    data: {
                        labels: ordersLabels,
                        datasets: [{
                            label: 'Commandes',
                            data: ordersData,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                            },
                            title: {
                                display: true,
                                text: 'Évolution des Commandes',
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                const ctxContacts = document.getElementById('contactsChart').getContext('2d');
                const contactsChart = new Chart(ctxContacts, {
                    type: 'bar',
                    data: {
                        labels: contactsLabels,
                        datasets: [{
                            label: 'Contacts',
                            data: contactsData,
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                            },
                            title: {
                                display: true,
                                text: 'Évolution des Contacts',
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                const ctxUsers = document.getElementById('usersChart').getContext('2d');
                const usersChart = new Chart(ctxUsers, {
                    type: 'line',
                    data: {
                        labels: usersLabels,
                        datasets: [{
                            label: 'Utilisateurs',
                            data: usersData,
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                            },
                            title: {
                                display: true,
                                text: 'Évolution des Utilisateurs',
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                const ctxVisits = document.getElementById('visitChart').getContext('2d');
                const visitChart = new Chart(ctxVisits, {
                    type: 'line',
                    data: {
                        labels: visitsLabels,
                        datasets: [{
                            label: 'Visites',
                            data: visitsData,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                            },
                            title: {
                                display: true,
                                text: 'Visites Récentes',
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            error: function(error) {
                console.error('Erreur lors de la récupération des données d\'évolution :', error);
            }
        });
    </script>
</body>
</html>
